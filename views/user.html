<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>用户管理</title>
    <link rel="stylesheet" type="text/css" href="/easyUI/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="/easyUI/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css">
    <script type="text/javascript" src="/javascripts/jquery.min.js"></script>
    <script type="text/javascript" src="/javascripts/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/javascripts/default.js"></script>
</head>

<body>
    <table id="dg" title="用户管理" style="width:100%;height:650px" data-options="rownumbers:true,remoteSort:false,multiSort:true,singleSelect:true,pagination:true,url:'users/list',method:'get',toolbar:'#tb' 
">
        <thead>
            <tr>
                <th data-options="field:'ck',checkbox:true"></th>
                <th data-options="field:'userId',align:'center'">ID</th>
                <th data-options="field:'userName',align:'center',sortable:true,editor:'text',width:100">用户名</th>
                <th data-options="field:'userAvatar',align:'center',width:100" formatter="imageFormatter">头像</th>
                <th data-options="field:'userPhone',align:'center',sortable:true,width:90,editor:'text'">电话</th>
                <th data-options="field:'userGender',align:'center',sortable:true,width:50,editor:{type:'combobox',options:{valueField: 'value',textField: 'label', data: [{label: '保密',value: 0},{label: '男',value: 1},{label: '女',value: 2}]}}" formatter="genderFormatter">性别</th>
                <th data-options="field:'createTime',align:'center',sortable:true,width:130" formatter="detetimeFormatter">创建时间</th>
                <th data-options="field:'updateTime',align:'center',sortable:true,width:130" formatter="detetimeFormatter">修改时间</th>
            </tr>
        </thead>
    </table>
    <div id="tb">
        <p><span>修改：</span><a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true" onclick="accept()">保存</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-undo',plain:true" onclick="reject()">撤销</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-search',plain:true" onclick="getChanges()">GetChanges</a>
        </p>
        <p><span>删除：</span><a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="deleteUser()">删除</a></p>
        <p><span>搜索：</span>
            <div>
                <input name="userName" class="easyui-textbox" data-options="label:'用户名:'">
            </div>
            <div>
                <input name="userPhone" class="easyui-textbox" data-options="label:'电话号码:'">
            </div>
            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-search',plain:true" onclick="doSearch()">搜索</a>
    </div>
    <script type="text/javascript">
    var $dg = $('#dg');


    function genderFormatter(val, row, index) {
        var gender = "保密";
        if (val == 1) {
            gender = "男"
        } else if (val == 2) {
            gender = "女"
        }
        return gender;
    }

    function detetimeFormatter(val, row, index) {
        return new Date(val).format("yyyy-MM-dd hh:mm:ss");
    }

    function imageFormatter(val, row, index) {
        return '<img src="' + val + '" alt="">';
    }

    function deleteUser() {
        $.messager.confirm('删除', '确定要删除？', function(r) {
            if (r) {
                var rows = $dg.datagrid('getSelected');
                $.ajax({
                    type: "post",
                    url: "/users/deleteUser",
                    data: { userId: rows.userId },
                    dataType: "json",
                    success: function(data) {
                        $dg.datagrid('reload');
                    }
                });
            }
        });
    }

    var editIndex = undefined;

    function getCurrRowIndex() {
        var tr = $("[name='ck']:checked").closest('tr.datagrid-row');
        return parseInt(tr.attr('datagrid-row-index'));
    }

    function accept() {
        $dg.datagrid('endEdit', getCurrRowIndex());
        var rows = $dg.datagrid('getChanges');
        console.log(rows);
        var update_times = rows.length;

        for (i in rows) {
            $.ajax({
                type: "post",
                url: "/users/updateUser",
                data: rows[i],
                dataTpye: "json",
                success: function(data) {
                    update_times--;
                    if (update_times === 0) {
                        $dg.datagrid('reload');
                    }
                }
            });
        }
    }

    function reject() {
        $dg.datagrid('rejectChanges');
        editIndex = undefined;
    }

    function getChanges() {
        var rows = $dg.datagrid('getChanges');
        alert(rows.length + ' rows are changed!');
    }


    function doSearch() {
        $dg.datagrid('load', {
            userName: $('[name="userName"]').val(),
            userPhone: $('[name="userPhone"]').val()
        });
    }
    $(function() {
        var datagrid = $dg.datagrid();
        setTimeout(function() { $dg.datagrid('fixRowHeight'); }, 100);
        datagrid.datagrid('enableCellEditing');
    });
    </script>
</body>

</html>